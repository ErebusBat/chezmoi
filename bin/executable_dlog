#!/bin/zsh

# Setup paths, support known locations for vault root
LOGS_PATH="logs/$(date +%Y/%m-%b)"
FILE_NAME="$(date +%F-%a).md"
WIKI_ROOT_PATHS=(
  ~/Documents/Obsidian/vimwiki   # Mac
  ~/Sync/Obsidian/vimwiki        # Thelio (SyncThing)
  ~/vimwiki                      # Thelio (Obsidian)
)

# Find root path, error if not found
for p in $WIKI_ROOT_PATHS; do
  if [[ -d $p ]]; then
    WIKI_ROOT_PATH=$p
    break
  fi
done
if [[ ! -d $WIKI_ROOT_PATH ]]; then
  echo "*** FATAL: Could not find wiki root path!"
  exit 1
fi

# Build final paths
FULL_DIR_PATH="$WIKI_ROOT_PATH/$LOGS_PATH"
FULL_FILE_PATH="$FULL_DIR_PATH/$FILE_NAME"

# echo "[$(date)] --------------------------------------------------------------------------------" >> /tmp/dlog.log

ENTRY=""
while [[ -n $1 ]]; do
  ENTRY="${ENTRY} ${1}"
  shift
done
# Strip leading and trailing spaces
ENTRY=${(MS)ENTRY##[[:graph:]]*[[:graph:]]}

# echo "[$(date)] ENTRY>>>$ENTRY<<<" >> /tmp/dlog.log

# Does the entry have the special pasteboard indicator?
PASTEBOARD=$(echo $ENTRY | grep '%%')
PB_SEACH_EC=$?
if [[ $PB_SEACH_EC -eq 0 ]]; then
  # echo "[$(date)] pbpaste>>>$(pbpaste)<<<" >> /tmp/dlog.log
  PASTEBOARD=$(~/bin/tg-markdown -)
  # echo "[$(date)] PASTEBOARD>>>$PASTEBOARD<<<" >> /tmp/dlog.log
  PASTEBOARD=${(MS)PASTEBOARD##[[:graph:]]*[[:graph:]]}
  # echo "[$(date)] PASTEBOARD>>>$PASTEBOARD<<<" >> /tmp/dlog.log
  # Replace %% with the contents of tg-markdown-ified pasteboard
  ENTRY="${ENTRY//\%\%/$PASTEBOARD}"
fi
# echo "[$(date)] ENTRY>>>$ENTRY<<<" >> /tmp/dlog.log

if [[ -z $ENTRY ]]; then
  echo "*** FATAL: No log message provided; aborting." >&2
  exit 1
fi
if [[ ! -f $FULL_FILE_PATH ]]; then
  echo "*** FATAL: Could not find log file, create in Obsidian first.  Looking for $FULL_FILE_PATH" >&2
  exit 2
fi

################################################################################
# Some Global Replacements
################################################################################
#- Emojis
ENTRY=${ENTRY:gs/:100:/ðŸ’¯}
ENTRY=${ENTRY:gs/:bee:/ðŸ}
ENTRY=${ENTRY:gs/:book:/ðŸ“–}
ENTRY=${ENTRY:gs/:broom:/ðŸ§¹}
ENTRY=${ENTRY:gs/:bun:/ðŸ‡}
ENTRY=${ENTRY:gs/:bus:/ðŸšŒ}
ENTRY=${ENTRY:gs/:check:/âœ…}
ENTRY=${ENTRY:gs/TASK/âœ…}
ENTRY=${ENTRY:gs/WORK/âš’ï¸}
ENTRY=${ENTRY:gs/:cheese:/ðŸ§€}
ENTRY=${ENTRY:gs/:cherries:/ðŸ’}
ENTRY=${ENTRY:gs/:cherry:/ðŸ’}
ENTRY=${ENTRY:gs/:coffee:/â˜•ï¸}
ENTRY=${ENTRY:gs/:cofin:/âš°ï¸}
ENTRY=${ENTRY:gs/:duck:/ðŸ¦†}
ENTRY=${ENTRY:gs/:evil:/ðŸ˜ˆ}
ENTRY=${ENTRY:gs/:food:/ðŸ±}
ENTRY=${ENTRY:gs/:hot:/ðŸ¥µ}
ENTRY=${ENTRY:gs/:kiss:/ðŸ˜˜}
ENTRY=${ENTRY:gs/:memo:/ðŸ“}
ENTRY=${ENTRY:gs/:money:/ðŸ’µ}
ENTRY=${ENTRY:gs/:music:/ðŸŽµ}
ENTRY=${ENTRY:gs/:meet:/ðŸ§‘â€ðŸ¤â€ðŸ§‘}
ENTRY=${ENTRY:gs/:pen:/âœ’ï¸}
ENTRY=${ENTRY:gs/:phone:/â˜Ž}
ENTRY=${ENTRY:gs/:pill:/ðŸ’Š}
ENTRY=${ENTRY:gs/:pin:/ðŸ“Œ}
ENTRY=${ENTRY:gs/:pizza:/ðŸ•}
ENTRY=${ENTRY:gs/:ppcot:/ðŸ™ðŸ’}
ENTRY=${ENTRY:gs/:pray:/ðŸ™}
ENTRY=${ENTRY:gs/:puzzle:/ðŸ§©}
ENTRY=${ENTRY:gs/:rofl:/ðŸ¤£}
ENTRY=${ENTRY:gs/:run:/ðŸƒ}
ENTRY=${ENTRY:gs/:school:/ðŸŽ“}
ENTRY=${ENTRY:gs/:shh:/ðŸ¤«}
ENTRY=${ENTRY:gs/:shower:/ðŸš¿}
ENTRY=${ENTRY:gs/:taco:/ðŸŒ®}
#- Personal Metrics Tracking
ENTRY=${ENTRY:gs/MEDITATE/ðŸ§  Meditation}
ENTRY=${ENTRY:s/CALL /â˜Ž }
ENTRY=${ENTRY:s/FEEL /ðŸ§  }
ENTRY=${ENTRY:s/FOOD /ðŸ± }
ENTRY=${ENTRY:s/MED /ðŸ’Š }    # :pill:
ENTRY=${ENTRY:s/MEM /ðŸ“ }    # :memo:
ENTRY=${ENTRY:s/REM /ðŸ“ }    # :memo:
ENTRY=${ENTRY:s/T /âœ… }
ENTRY=${ENTRY:s/W /âš’ï¸ }
#- Personal
ENTRY=${ENTRY:gs/DARTER/[[dartp6]]}
ENTRY=${ENTRY:gs/FreeNAS/[[FreeNAS]]}
ENTRY=${ENTRY:gs/LUNCH/ðŸ± Lunch}
ENTRY=${ENTRY:gs/M4MBP/[[MacBook Pro M4|m4mbp]]}
ENTRY=${ENTRY:gs/NAS/[[FreeNAS]]}
ENTRY=${ENTRY:gs/NUC/[[IntelNUC|nuc01]]}   # Needs to be BEFORE MAZE or we will have conflicts
ENTRY=${ENTRY:gs/MAZE/[[IntelNUC 2 - Maze|Maze]]}
ENTRY=${ENTRY:gs/SHOWER/ðŸš¿ Shower}
ENTRY=${ENTRY:gs/THELIO/[[System76 Thelio Deskop|Thelio]]}
#- CCAM - Entities
ENTRY=${ENTRY:gs/CCAM/[[CompanyCam]]}
ENTRY=${ENTRY:gs/16MBP/[[CompanyCam 16\" MacBook Pro|CCAM-16MBP]]}
#- CCAM - People
ENTRY=${ENTRY:gs/CAMW/[[Cameron Wiebe|Cam]]}
#- CCAM - Projects / Pages

# Spotify
if [[ $ENTRY == *SONG* ]]; then
  SONG=$(gospt now | sed -E 's/^[â¸â–¶ ]+//g' )
  if [[ -z $SONG ]]; then
    SONG="ðŸŽµ *ERR*: could not get song from spotify"
  else
    SONG="ðŸŽµ ${SONG}"
  fi
  ENTRY=${ENTRY:gs/SONG/$SONG}
fi

TIMESTAMP=$(date +%H:%M)
MD_TEXT="\n- *${TIMESTAMP}* - ${ENTRY}"
# echo "[$(date)] MD_TEXT>>>$MD_TEXT<<<" >> /tmp/dlog.log

# echo "Would have added '${MD_TEXT}' to ${FULL_FILE_PATH}"
echo $MD_TEXT >> $FULL_FILE_PATH
echo "[${TIMESTAMP}] ${ENTRY}"

# Remove trailing LF from file
echo -n "$(cat $FULL_FILE_PATH)" > $FULL_FILE_PATH
